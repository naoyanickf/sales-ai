<section class="py-5">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
      <div>
        <p class="text-uppercase text-primary fw-semibold mb-1">Workspace</p>
        <h1 class="fs-2 fw-semibold mb-0"><%= @workspace.name %></h1>
      </div>
      <span class="badge text-bg-light border ms-auto">
        <%= @workspace_membership.admin? ? "管理者として参加" : "参加者として参加" %>
      </span>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <h2 class="fs-5 fw-semibold mb-3">基本情報</h2>
            <p class="text-body-secondary">現在の名前: <strong><%= @workspace.name %></strong></p>

            <% if @workspace_membership.admin? %>
              <%= form_with model: @workspace,
                            url: workspace_path(@workspace),
                            method: :patch do |form| %>
                <%= render "shared/form_errors", object: @workspace %>

                <div class="mb-3">
                  <%= form.label :name, "ワークスペース名", class: "form-label" %>
                  <%= form.text_field :name, autofocus: true, class: "form-control" %>
                </div>

                <%= form.submit "名前を更新する", class: "btn btn-primary" %>
              <% end %>
            <% else %>
              <div class="alert alert-info mb-0">
                名前の変更は管理者のみが実行できます。
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <h2 class="fs-5 fw-semibold mb-3">メンバー一覧</h2>
            <div class="list-group">
              <% @workspace_users.each do |membership| %>
                <% member = membership.user %>
                <% next if member.nil? %>
                <div class="list-group-item d-flex flex-wrap justify-content-between align-items-center gap-3">
                  <div>
                    <p class="mb-0 fw-semibold"><%= member.name.presence || member.email %></p>
                    <p class="mb-0 text-body-secondary small"><%= member.email %></p>
                  </div>
                  <div class="d-flex flex-wrap gap-2">
                    <span class="badge <%= membership.admin? ? "text-bg-primary" : "text-bg-light text-dark" %>">
                      <%= membership.admin? ? "管理者" : "参加者" %>
                    </span>
                    <% if member == current_user %>
                      <span class="badge text-bg-success">あなた</span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% if @workspace_membership.admin? %>
      <div class="row g-4 mt-1">
        <div class="col-lg-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h2 class="fs-5 fw-semibold mb-3">メンバー招待</h2>
              <p class="text-body-secondary">メールアドレス宛に招待メールを送信します。</p>
              <%= form_with model: @new_invitation,
                            url: workspace_invitations_path(@workspace),
                            method: :post do |form| %>
                <%= render "shared/form_errors", object: @new_invitation %>

                <div class="mb-3">
                  <%= form.label :email, "招待するメールアドレス", class: "form-label" %>
                  <%= form.email_field :email, required: true, class: "form-control" %>
                </div>

                <%= form.hidden_field :role, value: "participant" %>

                <%= form.submit "招待メールを送信する", class: "btn btn-primary" %>
              <% end %>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h2 class="fs-5 fw-semibold mb-3">保留中の招待</h2>
              <% if @pending_invitations.any? %>
                <div class="list-group">
                  <% @pending_invitations.each do |invitation| %>
                    <div class="list-group-item">
                      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <div>
                          <p class="mb-1 fw-semibold"><%= invitation.email %></p>
                          <p class="mb-0 text-body-secondary small">
                            招待者:
                            <%= invitation.inviter.name.presence || invitation.inviter.email %>
                            /
                            招待日時:
                            <%= l(invitation.created_at.in_time_zone, format: :long) %>
                          </p>
                        </div>
                        <div class="d-flex flex-wrap gap-2 ms-auto">
                          <%= button_to "再送",
                                        resend_workspace_invitation_path(@workspace, invitation),
                                        class: "btn btn-outline-secondary btn-sm",
                                        form: { class: "d-inline" } %>
                          <%= button_to "削除",
                                        workspace_invitation_path(@workspace, invitation),
                                        method: :delete,
                                        class: "btn btn-outline-danger btn-sm",
                                        form: {
                                          class: "d-inline",
                                          data: { turbo_confirm: "この招待を削除してもよろしいですか？" }
                                        } %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="alert alert-info mb-0">現在、保留中の招待はありません。</div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <details class="mt-4 card shadow-sm border-danger">
      <summary class="card-header bg-transparent border-0 text-danger fw-semibold pointer">
        ワークスペースの削除
      </summary>
      <div class="card-body">
        <% if @workspace_membership.admin? %>
          <p class="text-body-secondary small">
            削除すると復元できません。確認のためにワークスペース名（<strong><%= @workspace.name %></strong>）を入力してください。
          </p>
          <%= form_with url: workspace_path(@workspace), method: :delete do |form| %>
            <% if @deletion_error.present? %>
              <div class="alert alert-danger" role="alert"><%= @deletion_error %></div>
            <% end %>

            <div class="mb-3">
              <%= form.label :confirm_name, "確認用ワークスペース名", class: "form-label" %>
              <%= form.text_field :confirm_name, class: "form-control" %>
            </div>

            <%= form.submit "ワークスペースを削除する",
                            class: "btn btn-outline-danger btn-sm",
                            data: { turbo_confirm: "本当に削除してよろしいですか？" } %>
          <% end %>
        <% else %>
          <div class="alert alert-warning mb-0 small">
            削除操作は管理者のみが実行できます。
          </div>
        <% end %>
      </div>
    </details>
  </div>
</section>
