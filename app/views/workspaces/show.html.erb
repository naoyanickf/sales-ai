<section class="workspace-manage">
  <h1>ワークスペース管理</h1>
  <p>参加中のメンバーはこのページを閲覧できます。管理操作は管理者のみが行えます。</p>

  <div class="workspace-section">
    <h2>基本情報</h2>
    <p>現在の名前: <strong><%= @workspace.name %></strong></p>

    <% if @workspace_membership.admin? %>
      <%= form_with model: @workspace, url: workspace_path(@workspace), method: :patch do |form| %>
        <% if @workspace.errors.any? %>
          <ul class="form-errors">
            <% @workspace.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        <% end %>

        <div class="field">
          <%= form.label :name, "ワークスペース名" %>
          <%= form.text_field :name, autofocus: true %>
        </div>

        <%= form.submit "名前を更新する" %>
      <% end %>
    <% else %>
      <p class="help-text">名前の変更は管理者のみが実行できます。</p>
    <% end %>
  </div>

  <div class="workspace-section">
    <h2>メンバー一覧</h2>
    <ul>
      <% @workspace_users.each do |membership| %>
        <% member = membership.user %>
        <% next if member.nil? %>
        <li>
          <strong><%= member.name.presence || member.email %></strong>
          (<%= member.email %>)
          <% if membership.admin? %>
            <span class="role-badge">管理者</span>
          <% else %>
            <span class="role-badge">参加者</span>
          <% end %>
          <% if member == current_user %>
            <span class="role-badge current-user">あなた</span>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>

  <% if @workspace_membership.admin? %>
    <div class="workspace-section">
      <h2>メンバー招待</h2>
      <%= form_with model: @new_invitation, url: workspace_invitations_path(@workspace), method: :post do |form| %>
        <% if @new_invitation&.errors&.any? %>
          <ul class="form-errors">
            <% @new_invitation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        <% end %>

        <div class="field">
          <%= form.label :email, "招待するメールアドレス" %>
          <%= form.email_field :email, required: true %>
        </div>

        <%= form.hidden_field :role, value: "participant" %>

        <%= form.submit "招待メールを送信する" %>
      <% end %>
    </div>

    <div class="workspace-section">
      <h2>保留中の招待</h2>
      <% if @pending_invitations.any? %>
        <ul>
          <% @pending_invitations.each do |invitation| %>
            <li>
              <strong><%= invitation.email %></strong>
              （招待者: <%= invitation.inviter.name.presence || invitation.inviter.email %> /
              招待日時: <%= l(invitation.created_at) %>）
            </li>
          <% end %>
        </ul>
      <% else %>
        <p>現在、保留中の招待はありません。</p>
      <% end %>
    </div>
  <% end %>

  <div class="workspace-section danger-zone">
    <h2>ワークスペースの削除</h2>
    <% if @workspace_membership.admin? %>
      <p>削除すると復元できません。確認のためにワークスペース名（<strong><%= @workspace.name %></strong>）を入力してください。</p>

      <%= form_with url: workspace_path(@workspace), method: :delete do |form| %>
        <% if @deletion_error.present? %>
          <p class="form-errors"><%= @deletion_error %></p>
        <% end %>

        <div class="field">
          <%= form.label :confirm_name, "確認用ワークスペース名" %>
          <%= form.text_field :confirm_name %>
        </div>

        <%= form.submit "ワークスペースを削除する", data: { turbo_confirm: "本当に削除してよろしいですか？" } %>
      <% end %>
    <% else %>
      <p class="help-text">削除操作は管理者のみが実行できます。</p>
    <% end %>
  </div>
</section>
