<% products_active = %w[products product_documents].include?(controller_name) %>
<% chat_active = %w[chats messages].include?(controller_name) %>
<aside class="auth-sidebar bg-dark text-white p-4 d-flex flex-column" id="sidebar">
  <div class="sidebar-top d-flex flex-column gap-2 mb-2">
    <%= link_to authenticated_root_path, class: "align-self-start d-inline-flex align-items-center justify-content-center rounded bg-white bg-opacity-10 text-white text-decoration-none", style: "width: 40px; height: 40px;" do %>
      <i data-lucide="sparkles" aria-hidden="true"></i>
    <% end %>
    <p class="text-white-50 text-uppercase small fw-semibold mt-2 mb-1">ワークスペース</p>
    <div class="dropdown w-100">
      <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <span class="text-truncate">
          <%= current_workspace&.name || "ワークスペース" %>
        </span>
        <i data-lucide="chevron-down" aria-hidden="true"></i>
      </button>
      <div class="dropdown-menu dropdown-menu-dark w-100 mt-2" style="min-width: 100%; inset: auto auto auto 0;">
        <% if current_workspace.present? %>
          <%= link_to workspace_path(current_workspace),
                      class: "dropdown-item d-flex align-items-center gap-2" do %>
            <i data-lucide="settings" aria-hidden="true"></i>
            <span>設定</span>
          <% end %>
          <div class="dropdown-divider"></div>
        <% end %>

        <div class="px-3 pb-1 text-white-50 small text-uppercase">ワークスペースを切り替え</div>
        <% sidebar_memberships.each do |membership| %>
          <% workspace = membership.workspace %>
          <% next if workspace.nil? %>
          <% active = current_workspace&.id == workspace.id %>
          <%= button_to switch_workspace_path,
                       params: { workspace_uuid: workspace.uuid },
                       method: :post,
                       form: { class: "dropdown-item-form" },
                       class: "dropdown-item d-flex justify-content-between align-items-center #{'active' if active}" do %>
            <span class="text-truncate"><%= workspace.name %></span>
            <% if active %>
              <span class="badge text-bg-light text-dark ms-2">表示中</span>
            <% end %>
          <% end %>
        <% end %>

        <div class="dropdown-divider"></div>
        <%= link_to new_workspace_path, class: "dropdown-item d-flex align-items-center gap-2" do %>
          <i data-lucide="plus" aria-hidden="true"></i>
          <span>新しいワークスペースを作成</span>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <p class="text-white-50 text-uppercase small fw-semibold mb-2">メニュー</p>
    <nav class="nav flex-column gap-1">
      <%= link_to products_path,
                  class: "text-decoration-none d-flex align-items-center gap-2 py-2 px-1 rounded #{products_active ? 'text-white fw-semibold' : 'text-white-50'}" do %>
        <i data-lucide="package" aria-hidden="true"></i>
        <span>製品</span>
      <% end %>
    </nav>
  </div>

  <div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <p class="text-white-50 text-uppercase small fw-semibold mb-0">最近のチャット</p>
      <%= link_to "もっと見る",
                  chats_path,
                  class: "text-white-50 small text-decoration-none" %>
    </div>
    <% recent_chats = sidebar_recent_chats %>
    <% if recent_chats.present? %>
      <div class="d-flex flex-column gap-2">
        <% recent_chats.each do |chat| %>
          <%= link_to chat_path(chat),
                      class: "text-decoration-none bg-white bg-opacity-10 rounded px-3 py-2 d-flex flex-column gap-1" do %>
            <span class="text-white fw-semibold text-truncate"><%= chat.display_title %></span>
            <small class="text-white-50 text-truncate">
              <%= chat.product&.name || "製品未設定" %>・<%= l(chat.updated_at, format: :short) %>
            </small>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p class="text-white-50 small mb-0">チャット履歴がまだありません。</p>
    <% end %>
  </div>

  <div class="mt-auto pt-4 border-top border-white border-opacity-25">
    <div class="d-flex align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-3 flex-grow-1" style="min-width: 0;">
        <div class="rounded-circle bg-white bg-opacity-10 d-flex align-items-center justify-content-center text-white" style="width: 44px; height: 44px;">
          <i data-lucide="user-round" aria-hidden="true"></i>
        </div>
        <div class="text-start flex-grow-1" style="min-width: 0;">
          <p class="mb-0 fw-semibold text-truncate" style="max-width: 160px;"><%= current_user.name %></p>
          <p class="mb-0 text-white-50 small text-truncate" style="max-width: 160px;"><%= current_user.email.split("@").first %></p>
        </div>
      </div>
      <%= link_to edit_profile_path, class: "btn btn-link text-white p-0 d-flex align-items-center justify-content-center", style: "width: 36px; height: 36px;", title: "設定" do %>
        <span class="visually-hidden">設定</span>
        <i data-lucide="settings" aria-hidden="true"></i>
      <% end %>
    </div>
    <div class="mt-3">
      <%= button_to "ログアウト", destroy_user_session_path, method: :delete, class: "btn btn-outline-light w-100 text-start", form: { class: "w-100" } %>
    </div>
  </div>
</aside>
