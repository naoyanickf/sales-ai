<section class="py-4">
  <div class="container">
    <div class="row g-4">
      <div class="col-12 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <p class="text-uppercase text-primary fw-semibold small mb-1">Context</p>
                <h2 class="h5 mb-0">チャット設定</h2>
              </div>
              <i data-lucide="sliders-horizontal" class="text-primary" aria-hidden="true"></i>
            </div>

            <%= turbo_frame_tag dom_id(@chat, :context) do %>
              <%= render "context_form",
                         chat: @chat,
                         products: @products,
                         sales_experts: @sales_experts %>
            <% end %>

            <hr class="my-4">
            <%= button_to "新しいチャットを開始",
                          chats_path,
                          method: :post,
                          class: "btn btn-outline-secondary w-100",
                          form: { data: { turbo_confirm: "現在の会話履歴をリセットしますか？" } } %>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card h-100 shadow-sm">
          <div class="card-header bg-white border-bottom-0">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="text-uppercase text-muted small mb-1">Streaming Chat</p>
                <h2 class="h5 mb-0">AI営業サポート</h2>
              </div>
              <div class="text-end small text-muted">
                <% if @chat.product.present? %>
                  <div>製品: <strong><%= @chat.product.name %></strong></div>
                <% end %>
                <% if @chat.sales_expert.present? %>
                  <div>担当AI: <strong><%= @chat.sales_expert.name %></strong></div>
                <% end %>
              </div>
            </div>
          </div>
          <div class="card-body d-flex flex-column">
            <%= turbo_stream_from "#{dom_id(@chat)}_messages" %>
            <div id="<%= dom_id(@chat) %>_messages"
                 class="chat-thread flex-grow-1 overflow-auto mb-3 d-flex flex-column gap-3"
                 data-chat-scroll-container>
              <% if @chat.messages.empty? %>
                <div class="text-center text-muted my-auto">
                  <p class="mb-1">まだメッセージがありません。</p>
                  <p class="mb-0">下のフォームから質問を送信してください。</p>
                </div>
              <% else %>
                <%= render @chat.messages %>
              <% end %>
            </div>
            <%= render "messages/form", chat: @chat, message: @message %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
