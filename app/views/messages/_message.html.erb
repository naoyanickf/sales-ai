<% scroll = local_assigns.fetch(:scroll_to, false) %>
<% alignment = message.user? ? "justify-content-end" : "justify-content-start" %>
<% bubble_class = message.user? ? "bg-primary text-white" : "bg-light" %>
<% text_class = message.user? ? "text-white" : "text-dark" %>
<% typing = message.assistant? && message.content.blank? %>

<div id="<%= dom_id(message) %>_messages"
     class="d-flex <%= alignment %> mb-2"
     data-chat-scroll-anchor="<%= scroll %>">
  <div class="rounded-4 px-3 py-2 <%= bubble_class %> shadow-sm" style="max-width: 85%;">
    <% if message.user? %>
      <p class="small text-white-50 mb-1">あなた</p>
    <% else %>
      <p class="small text-muted mb-1">AI営業アシスタント</p>
    <% end %>
    <div class="<%= text_class %> mb-0 chat-bubble-content">
      <% if typing %>
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-grow spinner-grow-sm text-secondary"
               role="status"
               aria-label="AIの回答を生成中"></div>
          <p class="small text-muted mb-0">
            回答を生成しています
          </p>
        </div>
      <% else %>
        <%= render_markdown(message.content) %>
      <% end %>
    </div>
  </div>
</div>
